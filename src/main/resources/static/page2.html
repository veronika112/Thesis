<meta charset="utf-8" />
<html>
<head>
<style>
#subjects {
	font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
	border-collapse: collapse;
	width: 60%;
}

#subjects td, #subjects th {
	border: 1px solid #ddd;
	padding: 8px;
}

#subjects th {
	padding-top: 12px;
	padding-bottom: 12px;
	text-align: left;
	background-color: #7DBBE8;
	color: white;
}

.button {
	background-color: #7DBBE8; /* Blue */
	border: none;
	color: white;
	padding: 15px 32px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	font-size: 16px;
	position: absolute;
}

.dropbtn {
	background-color: #B7C1C8;
	color: black;
	padding: 16px;
	font-size: 16px;
	border: none;
	cursor: pointer;
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
	position: relative;
	display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
	display: none;
	position: absolute;
	background-color: #f9f9f9;
	min-width: 160px;
	box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
	z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
	color: black;
	padding: 12px 16px;
	text-decoration: none;
	display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {
	background-color: #f1f1f1
}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
	display: block;
}

/* Change the background color of the dropdown button when the dropdown content is shown */
.dropdown:hover .dropbtn {
	background-color: #D3E5F2;
}
</style>
</head>
<body>

	<center>
		<div style="text-align: center">
			<h1>Генератор на учебна програма!</h1>
			<br>
			<h2 id="h2"></h2>
		</div>
		<br> <br> <br>
		<table id="subjects">
			<tr>
				<th>№</th>
				<th>Предмет</th>
				<th>Брой лекции</th>
				<th>Брой упражнения</th>
				<th>Избор на преподавател</th>
			</tr>
		</table>
	</center>
	<br>
	<br>
	<br>
	<br>
	<div>
		<button style="left: 20%;" class="button" onclick="back()">Назад</button>
		<button style="left: 70%;" class="button" onclick="process()">Продължи</button>
	</div>

	<script>
		var semesterIdFromPage1 = -1;
		var numGroupsFromPage1 = -1;
	
	
		function process() {
			console.log("processs");
			var flag = true;
			var subj = document.getElementById('subjects').getElementsByTagName('tr');
			console.log("subjects: " + subj);
			
			for( var i=1; i<subj.length; i++){
				if (subj[i].children[4].innerHTML.indexOf('Избор...') !== -1){
					flag = false;
				}
			}
			
			if(flag == false){
				alert("Моля, попълнете всички преподаватели!");
			} else {
				console.log("preminawame kam stranica 3");
				window.location.href = "page3.html";
			}
		}
	
		function back() {
			var url = "/";
				
			window.location.href = url;
		}
	
		function appendQueryString(url, queryVars) {
			var firstSeperator = (url.indexOf('?') == -1 ? '?' : '&');
			var queryStringParts = new Array();
			for (var key in queryVars) {
				queryStringParts.push(key + '=' + queryVars[key]);
			}
			var queryString = queryStringParts.join('&');
			return url + firstSeperator + queryString;
		}
	
	
		window.onload = function getSemesters() {
			//	console.log("getSemesters");
	
			var urlParams = new URLSearchParams(window.location.search);
			var semesterId = urlParams.get('semesterId');
			semesterIdFromPage1 = semesterId;
			numGroupsFromPage1 = urlParams.get('groups');
			//	console.log(urlParams);
	
			document.getElementById("h2").innerHTML = "Списък от предмети за семестър №" + (parseInt(semesterId, 10) + 1) + " за специалност ИТИ:";
	
	
			var xhttp = new XMLHttpRequest();
			var subjects = null;
			xhttp.onreadystatechange = function() {
				//	console.log("state: " + this.readyState + "status: " + this.status);
				if (this.readyState == 4 && this.status == 200) {
					subjects = this.responseText;
					var sub = JSON.parse(subjects);
					var subjectTable = document.getElementById('subjects');
	
					for (i = 0; i < sub.length; i++) {
					//	var subId = sub[i].id;
						console.log("Subjects: " + i);
			
						
						var tr = document.createElement('tr');
						var tdNum = document.createElement('td');
						tdNum.innerHTML = (i + 1);
	
						var tdName = document.createElement('td');
						tdName.innerHTML = sub[i].name;
	
						var tdLec = document.createElement('td');
						tdLec.innerHTML = sub[i].lecture_num;
	
						var tdEx = document.createElement('td');
						tdEx.innerHTML = sub[i].exercises_num;
	
							
						<!-- td -->
						var tdDropDown = document.createElement('td');
	
						<!--td dropdown -->
						var dropDown = document.createElement('div');
						dropDown.className = "dropdown";
	
	
						var dropDownContent = document.createElement('div');
						dropDownContent.id = "dropDownCon"
						dropDownContent.className = "dropdown-content";
	
						var teachers = null;
						var xhttp = new XMLHttpRequest();
						xhttp.onreadystatechange = function() {
							//	console.log("state: " + this.readyState + "status: " + this.status);
							if (this.readyState == 4 && this.status == 200) {
								teachers = this.responseText;
	
								console.log("Wutreshniq callback!");
	
								var button = document.createElement('button');
								button.className = "dropbtn";
								button.innerHTML = "Избор...";
	
								var teach = JSON.parse(teachers);
	
	
								for (j = 0; j < teach.length; j++) (function(j) {
										var content = teach[j].name;
										var teachId = teach[j].id;
										var subId = sub[i].id;
										var currentI = i;
										
										var a = document.createElement('a');
										a.innerHTML = content;
										a.id = i;
										a.onclick = function() {
											button.innerHTML = content;
										// tuk w obshtata pamet zapiswame stoinosti K-V, za da pazim Predmet-Prepodawatel
										// key -> id-to na subject [istinskoto id ot bazata], value id-to na prepodawatelq 
											console.log("Key: " + currentI + "-"+ sub.length + ", VALUE: " + subId  +";"+teachId);	
											
											sessionStorage.setItem(currentI+"-"+sub.length, subId +";"+teachId);
											
										}
										dropDownContent.appendChild(a);
									})(j);
	
	
								dropDown.appendChild(button);
								dropDown.appendChild(dropDownContent);
	
	
								tdDropDown.appendChild(dropDown);
	
							}
	
						};
	
						tr.appendChild(tdNum);
						tr.appendChild(tdName);
						tr.appendChild(tdLec);
						tr.appendChild(tdEx);
						tr.appendChild(tdDropDown);
	
						subjectTable.appendChild(tr);
	
						xhttp.open("GET", "/teachers/bySubject?id=" + (i + 1) + "&type=true", false);
						xhttp.send();
	
					} // for Subject
				}
			}
			xhttp.open("GET", "/subjects/semester?id=" + (parseInt(semesterId, 10) + 1), false);
			xhttp.send();
		}
	</script>
</body>
</html>